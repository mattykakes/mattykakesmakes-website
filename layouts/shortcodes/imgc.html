{{/*
  Shortcode: imgc.html
  Purpose:   Generate responsive images with WebP + JPEG sources, 
             a low-quality placeholder (LQIP), and optional CSP-safe styling.
             All images are fingerprinted for cache-busting.

  Usage (in Markdown content):
    {{< imgc src="example.jpg" alt="A descriptive alt text" >}}

  Optional parameters:
    - src     (string)  : required, image filename under assets/images/
    - alt     (string)  : required, alt text for accessibility
    - quality (integer) : optional, image quality (default = 75)

  Example with quality override:
    {{< imgc src="hero.jpg" alt="Hero banner" quality="90" >}}
*/}}

{{- /* Responsive image sizes (in px) */ -}}
{{- $respSizes := slice "450" "600" "900" "1200" "1500" "1800" -}}

{{- /* Base path for assets */ -}}
{{- $imgBase := "images/" -}}
{{- $src := resources.Get (printf "%s%s" $imgBase (.Get "src")) -}}
{{- $alt := .Get "alt" -}}

{{- /* Image quality (default 75 if not provided) */ -}}
{{- $quality := .Get "quality" | default "75" -}}

{{- /* Styling classes */ -}}
{{- $imgClass := "w-full h-auto animate-fade" -}}
{{- /* Constrain large screen size to blog container limit, on small screens use 100vw */ -}}
{{- $sizes := "(min-width: 800px) 800px, 100vw" -}}

{{- /* Low-quality placeholder (LQIP) */ -}}
{{- $lqip := $src.Resize (printf "20x q%s jpg" $quality) | fingerprint -}}
{{- $lqipB64 := $lqip.Content | base64Encode -}}
{{- $bgStyle := printf "background:url(data:image/jpeg;base64,%s);background-size:cover;background-repeat:no-repeat;" $lqipB64 -}}

{{- /* Fallback image */ -}}
{{- $fallback := $src.Resize (printf "800x q%s jpg" $quality) | fingerprint -}}

{{- /* CSP-safe option for Cloudflare Pages */ -}}
{{- $hash := md5 $src -}}
{{- if eq .Site.Params.Host "CFP" -}}
<style>
  .imgB-{{ $hash }} {
    {{ $bgStyle | safeCSS }}
  }
</style>
<div class="relative imgB-{{ $hash }} bg-center">
{{- else -}}
<div class="relative bg-center" style="{{ $bgStyle | safeCSS }}">
{{- end }}

  <picture>
    {{/* WebP sources first */}}
    <source type="image/webp"
      srcset="{{ range $i, $w := $respSizes -}}
        {{- if ge $src.Width $w -}}
          {{- if $i }}, {{ end -}}{{ ($src.Resize (printf "%sx q%s webp" $w $quality) | fingerprint).RelPermalink }} {{ $w }}w
        {{- end -}}
      {{- end }}"
      sizes="{{ $sizes }}" />

    {{/* JPEG fallback */}}
    <source type="image/jpeg"
      srcset="{{ range $i, $w := $respSizes -}}
        {{- if ge $src.Width $w -}}
          {{- if $i }}, {{ end -}}{{ ($src.Resize (printf "%sx q%s jpg" $w $quality) | fingerprint).RelPermalink }} {{ $w }}w
        {{- end -}}
      {{- end }}"
      sizes="{{ $sizes }}" />

    {{/* Fallback <img> for non-picture browsers */}}
    <img
      class="{{ $imgClass }}"
      src="{{ $fallback.RelPermalink }}"
      width="{{ $src.Width }}"
      height="{{ $src.Height }}"
      alt="{{ $alt }}"
      loading="lazy"
    />
  </picture>
</div>
